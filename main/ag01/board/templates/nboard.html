{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css" integrity="sha512-10/jx2EXwxxWqCLX/hHth/vu2KY3jCF70dCQB8TSgNjbCVAC/8vai53GfMDrO2Emgwccf2pJqxct9ehpzG+MTw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" type="text/css" href="{% static '/css/foodBoard.css' %}">
  <script src="http://code.jquery.com/jquery-latest.min.js"></script>
  <title>ANG-GGO</title>
  <script>
    // 1. ì‚¬ì´íŠ¸ GPS ì¶œë ¥
    $(function() {
        const radius = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë‹¨ìœ„: km)

        // ë‘ ì§€ì  ê°„ì˜ ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine ê³µì‹)
        function getDistance(lat1, lon1, lat2, lon2) {
            const toRad = (value) => (value * Math.PI) / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) ** 2 +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
                      Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return radius * c; // ë‹¨ìœ„: km
        }

        // Geolocation APIë¡œ í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜´
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(pos) {
                const userLat = pos.coords.latitude;
                const userLon = pos.coords.longitude;

                $('#latitude').html(userLat); // ìœ„ë„
                $('#longitude').html(userLon); // ê²½ë„

                // CSV íŒŒì¼ ì½ê¸°
                $.ajax({
                    url: '/static/ì¢Œí‘œë°ì´í„°.csv', // static í´ë”ì— ìˆëŠ” íŒŒì¼
                    dataType: 'text',
                    success: function(data) {
                        processCSVData(data, userLat, userLon);
                    },
                    error: function() {
                        alert('CSV íŒŒì¼ì„ ì½ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            });
        } else {
            alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }

        // CSV ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
        function processCSVData(data, userLat, userLon) {
            const lines = data.split("\n"); // ì¤„ ë‹¨ìœ„ë¡œ ë‚˜ëˆ”
            let nearestLocation = null; // ê°€ì¥ ê°€ê¹Œìš´ ìœ„ì¹˜
            let minDistance = Infinity; // ìµœì†Œ ê±°ë¦¬

            for (let i = 1; i < lines.length; i++) { // ì²« ë²ˆì§¸ ì¤„ì€ í—¤ë”
                const line = lines[i].trim();
                if (line) {
                    const columns = line.split(",");
                    const ì‹œë„ = columns[0];
                    const ì‹œêµ°êµ¬ = columns[1];
                    const ìœ„ë„ = parseFloat(columns[4]);
                    const ê²½ë„ = parseFloat(columns[5]);

                    // ì‚¬ìš©ì ìœ„ì¹˜ì™€ì˜ ê±°ë¦¬ ê³„ì‚°
                    const distance = getDistance(userLat, userLon, ìœ„ë„, ê²½ë„);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestLocation = `${ì‹œë„} ${ì‹œêµ°êµ¬}`;
                        nearestLocation_s = `${ì‹œêµ°êµ¬}`;
                    }
                }
            }

            // ê°€ì¥ ê°€ê¹Œìš´ ìœ„ì¹˜ ì¶œë ¥
            if (nearestLocation) {
                $("#gps").html(`<h2>${nearestLocation}</h2>`);
            } else {pass}
            // ê°€ì¥ ê°€ê¹Œìš´ ìœ„ì¹˜ ì¶œë ¥
            if (nearestLocation_s) {
                $("#gps_s").html(`<h2>${nearestLocation_s}  <i class="fa-solid fa-location-dot"></i></h2>`);
            } else {
                $("#gps_s").html("<p>ê·¼ì²˜ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>");
            }
        }
    });// 1ë²ˆ ë
    
</script>
</head>
<body>
  <!-- í—¤ë” ë¶€ë¶„ -->
  <header>
    <div class="inner">
      <a href="/"><span class="main_logo">ë¡œê³ </span></a>
      <ul>
        <a href="/map/mview/"><li>ì§€ë„</li></a>
        <a href="/foodBoard/blist/"><li>ë§›ì§‘ì¶”ì²œ</li></a>
        <a href="/board/nboard/"><li>ê²Œì‹œíŒ</li></a>
        <li>ì˜ˆì•½</li>
        <li>ì´ë²¤íŠ¸</li>
        <li>ë¸Œëœë“œ ì†Œê°œ</li>
      </ul>
      <span>
        <button type="button" class="ag_my"><a href="/member/login/">ë¡œê·¸ì¸/íšŒì›ê°€ì…</a></button>
        <button type="button" class="ag_my"><a href="/member/logout/">ë¡œê·¸ì•„ì›ƒ</a></button>
      </span>
    </div>
    <hr>
  </header>
  <!-- ë©”ì¸ ì‹¤í–‰ -->
  <main>
    <form action="#" name="mapping" method="post">
      {% csrf_token %}
      <button type="button" id="gps_s"></button>
      <input type="search" id="list_search" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." >
      <button id="seBtn">ê²€ìƒ‰</button>

      <!-- ìœ„ì¹˜ ëª¨ë‹¬ì°½ -->
      <div class="modal">
        <div class="modal_body">
            <h2>ì§€ì—­ ë³€ê²½</h2>
            <hr>
            <input type="text" name="chg" id="chg">
            <button type="button" id="chgBtn">ê²€ìƒ‰</button><br>
            <button type="button" class="now">í˜„ì¬ ë‚´ ìœ„ì¹˜ ì‚¬ìš©í•˜ê¸°</button>
            <p>ì¶”ì²œ</p>
            <ul>
              <li><a>ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬</a></li><br>
              <li><a>ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬</a></li><br>
              <li><a>ì„œìš¸íŠ¹ë³„ì‹œ ê°•ì„œêµ¬</a></li><br>
              <li><a>ê²½ê¸°ë„ ë¶€ì²œì‹œ</a></li><br>
              <li><a>ê²½ê¸°ë„ ìˆ˜ì›ì‹œ</a></li><br>
              <li><a>ì¸ì²œê´‘ì—­ì‹œ ì„œêµ¬</a></li><br>
              <li><a>ê²½ê¸°ë„ ë‚¨ì–‘ì£¼ì‹œ</a></li><br>
            </ul>
            <br>
            <button type="button" id="closeBtn">ë‹«ê¸°</button>
        </div>
    </div>
    </form>
    <div class="here">
      <div class="sub_navloc">HOME&nbsp;&nbsp; <strong><i class="fa-solid fa-chevron-right"></i>&nbsp;&nbsp; ê²Œì‹œíŒ</strong></div>
      <div id="gps">ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬</div>
    </div>
    <div class="board">
      <!-- ì¹´í…Œê³ ë¦¬ -->
      <div class="b_category">
        <ul>
          <li><a>ì¸ê¸°ê¸€ <img src="/static/images/heart.png" id="heart"></a></li><br>
          <li><a href="/board/nboard/?bselect=ì „ì²´">ì „ì²´</a></li><br>
          <li><a href="/board/nboard/?bselect=ì¶”ì²œë§›ì§‘">ì¶”ì²œë§›ì§‘</a></li><br>
          <li><a href="/board/nboard/?bselect=ê°ì„±ì¹´í˜">ê°ì„±ì¹´í˜</a></li><br>
          <li><a href="/board/nboard/?bselect=ì·¨ë¯¸">ì·¨ë¯¸</a></li><br>
          <li><a href="/board/nboard/?bselect=ì›¨ì´íŒ…">ì›¨ì´íŒ…</a></li><br>
          <li><a href="/board/nboard/?bselect=ì‹¤ì‹œê°„ê³µìœ ">ì‹¤ì‹œê°„ê³µìœ </a></li><br>
          <li><a href="/board/nboard/?bselect=ìƒí™œ/í¸ì˜">ìƒí™œ/í¸ì˜</a></li><br>
          <li><a href="/board/nboard/?bselect=êµí†µ">êµí†µ</a></li><br>
          <li><a href="/board/nboard/?bselect=í’ê²½">í’ê²½</a></li><br>
          <li><a href="/board/nboard/?bselect=ì‚¬ê±´ì‚¬ê³ ">ì‚¬ê±´ì‚¬ê³ </a></li><br>
          <li><a href="/board/nboard/?bselect=ê¸°íƒ€">ê¸°íƒ€</a></li><br>
        </ul>
      </div>
      <!-- ê²Œì‹œíŒ -->
      <div class="nlist">
        {% if blist %}
          {% for board in blist %}
          <ul>
            <a><li>
              <h3>{{board.btitle}}</h3>
              <p>{{board.bcontent}}</p>
              <span>{{board.bgps}}&nbsp;&nbsp;|&nbsp;&nbsp;{{board.bselect}}&nbsp;&nbsp;|&nbsp;&nbsp;{{board.bdate|date:'Y-m-d'}}</span><br>
              <span><i class="fa-regular fa-thumbs-up"></i>&nbsp;1&nbsp;&nbsp;<i class="fa-regular fa-comment"></i>&nbsp;2 </span><br>
                {% if board.bfile %}
                <img id="viewimg" src="{{board.bfile.url}}">
                {% else %}
                {% endif %}
            </li></a>
          </ul>
          {% endfor %}
          {% else %}
          <ul>
            <li style="font-size: 20px">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê²Œì‹œê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”!! ğŸ¤©</li>
          </ul>
          {% endif %}
      </div>
      <!-- ë¡œê·¸ì¸í•œ ì‚¬ëŒë§Œ ê¸€ì“°ê¸° ê°€ëŠ¥ -->
      {%if request.session.session_id%}
      <a id="add" href="/board/bwrite/"><img src="/static/images/add.png"></a>
      {% else %}
      {% endif %}
    </div>
    <div class="bottom">
      <ul class="page-num">
        <!-- ì´ì „í˜ì´ì§€ í™•ì¸ -->
        {% if blist.has_previous %}
          <a class="plz" href="/board/nboard/?npage=1"><li class="first"></li></a>
          <a class="plz" href="/board/nboard/?npage={{blist.previous_page_number}}"><li class="prev"></li></a>
        {% else %}
          <a class="plz"><li class="first"></li></a>
          <a class="plz"><li class="prev"></li></a>
        {% endif %}
        <!-- ìˆœì°¨í˜ì´ì§€ ë„˜ë²„ë§ -->
        {% for page in blist.paginator.page_range %}
        {% if page != npage %}
          <a href="/board/nboard/?npage={{page}}"><li class="num"><div>{{page}}</div></li></a>
        {% else %}
          <li class="num on"><div>{{page}}</div></li>
        {% endif %}
        {% endfor %}
        <!-- ë‹¤ìŒí˜ì´ì§€ í™•ì¸ -->
        {% if blist.has_next %}
          <a class="plz" href="/board/nboard/?npage={{blist.next_page_number}}"><li class="next"></li></a>
          <a class="plz" href="/board/nboard/?npage={{blist.paginator.num_pages}}"><li class="last"></li></a>
        {% else %}
          <a class="plz"><li class="next"></li></a>
          <a class="plz"><li class="last"></li></a>
        {% endif %}
      </ul>
    </div>
  </main>
  <!-- í•˜ë‹¨ ë¶€ë¶„ -->
  <footer>
    <div class="footer">
      <div class="ftnavi">
        <ul>
          <li><a href="">íšŒì‚¬ì†Œê°œ</a></li>
          <li><a href="">ì˜¤ì‹œëŠ”ê¸¸</a></li>
          <li><a href="">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a></li>
          <li><a href="">ì˜ìƒì •ë³´ì²˜ë¦¬ê¸°ê¸°ìš´ì˜ê´€ë¦¬ë°©ì¹¨</a></li>
          <li><a href="">ì´ìš©ì•½ê´€</a></li>
          <li><a href="">ì´ë©”ì¼ë¬´ë‹¨ìˆ˜ì§‘ê±°ë¶€</a></li>
        </ul>
        <div class="addr">
          <p>í¬ë ˆìŠ¤íŠ¸ ë¦¬ì†œ<span>|</span>ì¶©ì²­ë¶ë„ ì œì²œì‹œ ë°±ìš´ë©´ ê¸ˆë´‰ë¡œ 365</p>
          <p class="tel">ëŒ€í‘œë²ˆí˜¸ : 043-649-6000&nbsp;&nbsp;
          <span>ì˜ˆì•½ë¬¸ì˜ : 1600-0060</span>
          <span>ë‹¨ì²´ë¬¸ì˜ : 02-6177-5999</span>
          <span>ë¶„ì–‘ë¬¸ì˜ : 02-567-5555</span>
          <span>í†µì‹ íŒë§¤ì—…ì‹ ê³  : 2011-ì¶©ë¶ì œì²œ-0016í˜¸</span>
          </p>
          <p>ë©”ë¦¬ì¸ í™”ì¬ì™€ ê°œì¸ì •ë³´ ë°°ìƒì±…ì„ë³´í—˜ ê³„ì•½ì„ ì²´ê²°í•˜ì—¬ íšŒì› ê°œì¸ì •ë³´ë¥¼ ë³´í˜¸í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
          <p class="copy">COPYRIGHT(C) HOBAN HOTEL & RESORT. ALL RIGHTS RESERVED.</p>
        </div>
      </div>
      <div class="right">
        <div class="sns">
        </div>
        <div class="group">
          <select name="site_go" id="site_go" class="sel_box">
            <option value="#">íŒ¨ë°€ë¦¬ì‚¬ì´íŠ¸</option>
            <option value="https://www.ihoban.co.kr/web">í˜¸ë°˜ê±´ì„¤</option>
            <option value="https://www.hobanapt.co.kr/web">í˜¸ë°˜ë² ë¥´ë””ì›€</option>
          </select>
          <button type="button">GO</button>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // 2. ëª¨ë‹¬ì°½ í´ë¦­
    const modal = document.querySelector('.modal');
    const btnOpenModal=document.querySelector('#gps_s');
    const btnCloseModal=document.querySelector('#closeBtn');

    btnOpenModal.addEventListener("click", ()=>{
        modal.style.display="flex";
        $("body").addClass("modal-open");
    });
    btnCloseModal.addEventListener("click", ()=>{
        modal.style.display="none";
        $("body").removeClass("modal-open");
    });//2ë²ˆ ë
  </script>
</body>
</html>